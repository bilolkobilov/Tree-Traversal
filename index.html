<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Traversal Visualizer v4.0</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      :root {
        --primary-color: #2563eb; /* blue-600 */
        --primary-hover-color: #1d4ed8; /* blue-700 */
        --secondary-color: #4f46e5; /* indigo-600 */
        --accent-color: #ec4899; /* pink-500 */
        --success-color: #10b981; /* emerald-500 */
        --warning-color: #f59e0b; /* amber-500 */
        --error-color: #ef4444; /* red-500 */
        --light-bg: #f8fafc; /* slate-50 */
        --card-bg: #ffffff;
        --border-color: #e2e8f0; /* slate-200 */
        --text-primary: #1e293b; /* slate-800 */
        --text-secondary: #475569; /* slate-600 */
        --text-muted: #94a3b8; /* slate-400 */
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--light-bg);
        color: var(--text-primary);
        scroll-behavior: smooth;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

      /* Card Styling */
      .card {
        background-color: var(--card-bg);
        border-radius: 0.75rem; /* rounded-xl */
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.03), 0 2px 4px 0 rgba(0, 0, 0, 0.03);
        overflow: hidden;
        transition: box-shadow 0.3s ease;
      }
      .card:hover {
         box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      }
      .card-header {
        padding: 0.75rem 1.25rem; /* py-3 px-5 */
        border-bottom: 1px solid var(--border-color);
        background-color: #fcfdff; /* Slightly off-white */
      }
      .card-header h2 {
        font-size: 1rem; /* text-base */
        font-weight: 600; /* font-semibold */
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem; /* space-x-2 */
      }
      .card-content { padding: 1.25rem; } /* p-5 */
      .card-footer {
        padding: 0.75rem 1.25rem; /* py-3 px-5 */
        border-top: 1px solid var(--border-color);
        background-color: #f9fafb; /* slate-50 slightly adjusted */
      }

      /* Tab Styling */
      .tab-container { display: flex; border-bottom: 1px solid var(--border-color); background-color: #fdfdff; }
      .tab {
        flex: 1;
        padding: 0.875rem 1rem; /* py-3.5 px-4 */
        font-size: 0.875rem; /* text-sm */
        font-weight: 500; /* font-medium */
        color: var(--text-secondary);
        background-color: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem; /* space-x-1.5 */
        white-space: nowrap;
      }
      .tab:hover {
        background-color: #f8fafc; /* slate-50 */
        color: var(--primary-color);
      }
      .tab.active {
        color: var(--primary-color);
        font-weight: 600;
        border-bottom-color: var(--primary-color);
        background-color: #eff6ff; /* blue-50 */
      }
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      /* Button Styling */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem; /* space-x-1.5 */
        padding: 0.5rem 1rem; /* py-2 px-4 */
        border-radius: 0.5rem; /* rounded-lg */
        font-size: 0.875rem; /* text-sm */
        font-weight: 500; /* font-medium */
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        text-decoration: none;
        white-space: nowrap;
      }
      .btn:focus-visible {
         outline: 2px solid var(--primary-color);
         outline-offset: 2px;
      }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover-color); border-color: var(--primary-hover-color); transform: translateY(-1px); box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.07); }
      .btn-primary:active:not(:disabled) { transform: translateY(0); }

      .btn-secondary {
        background-color: var(--secondary-color);
        color: white;
        border-color: var(--secondary-color);
         box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      .btn-secondary:hover:not(:disabled) { background-color: #4338ca; border-color: #4338ca; transform: translateY(-1px); box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.07); }

      .btn-success {
        background-color: var(--success-color);
        color: white;
        border-color: var(--success-color);
         box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      .btn-success:hover:not(:disabled) { background-color: #059669; border-color: #059669; transform: translateY(-1px); box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.07); }

      .btn-outline {
        background-color: white;
        color: var(--text-secondary);
        border-color: var(--border-color);
      }
      .btn-outline:hover:not(:disabled) { border-color: #cbd5e1; /* slate-300 */ color: var(--text-primary); background-color: #f8fafc; }

      .btn-ghost {
        background-color: transparent;
        color: var(--text-secondary);
        border-color: transparent;
      }
      .btn-ghost:hover:not(:disabled) { background-color: #f1f5f9; /* slate-100 */ color: var(--text-primary); }

      .btn-icon {
        padding: 0.5rem; /* p-2 */
        border-radius: 9999px; /* rounded-full */
      }

      /* Tool Button Styling */
      .tool-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.75rem; /* p-3 */
        border: 1px solid var(--border-color);
        border-radius: 0.5rem; /* rounded-lg */
        background-color: var(--card-bg);
        transition: all 0.2s ease-in-out;
        text-align: center;
        cursor: pointer;
      }
      .tool-button:hover {
        background-color: #f8fafc; /* hover:bg-slate-50 */
        border-color: #cbd5e1; /* hover:border-slate-300 */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        transform: translateY(-2px);
      }
      .tool-button img { margin-bottom: 0.375rem; transition: transform 0.2s ease-in-out; }
      .tool-button:hover img { transform: scale(1.1); }
      .tool-button span { font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); }

      /* Form Input Styling */
      .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 0.5rem 0.75rem; /* py-2 px-3 */
        border: 1px solid var(--border-color);
        border-radius: 0.5rem; /* rounded-lg */
        font-size: 0.875rem; /* text-sm */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.02);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .form-input:focus, .form-textarea:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); /* blue-600 with opacity */
        outline: none;
      }
      .form-textarea { resize: vertical; min-height: 80px; }
      .form-range { accent-color: var(--primary-color); }

      /* Network Visualization Styling */
      #network, #animationNetwork {
        width: 100%;
        height: 550px; /* Increased height */
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        border-radius: 0.5rem; /* rounded-lg */
        position: relative;
        overflow: hidden;
      }
       #animationNetwork { height: 420px; } /* Adjusted height */
      .network-placeholder {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-muted);
        font-size: 0.875rem;
        display: flex; align-items: center; gap: 0.5rem;
        text-align: center;
      }
      /* Vis.js Overrides */
      .vis-network .vis-node {
        font-family: 'Inter', sans-serif;
        border-width: 2px !important;
      }
      .vis-label {
        color: #ffffff !important; font-weight: 500 !important; font-size: 13px !important;
      }
      .vis-network .vis-node.vis-selected { border-color: var(--warning-color) !important; }
      .vis-network .vis-edge { color: #94a3b8 !important; } /* slate-400 */

      /* Modal Styling */
      .modal {
        display: none; position: fixed; z-index: 100;
        left: 0; top: 0; width: 100%; height: 100%;
        overflow: auto; background-color: rgba(15, 23, 42, 0.6); /* slate-900 with opacity */
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease-out;
      }
      .modal-content {
        background-color: var(--card-bg);
        margin: 6% auto; padding: 0; /* Remove padding, handle inside */
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 600px; /* Increased width */
        animation: slideDown 0.3s ease-out;
        position: relative;
        overflow: hidden; /* Clip content */
      }
       .modal-header {
           padding: 1rem 1.5rem;
           border-bottom: 1px solid var(--border-color);
           display: flex;
           justify-content: space-between;
           align-items: center;
       }
       .modal-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }
       .modal-body { padding: 1.5rem; max-height: 65vh; overflow-y: auto; }
       .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background-color: #f9fafb; display: flex; justify-content: flex-end; gap: 0.75rem; }

      @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
      @keyframes slideDown { from { transform: translateY(-25px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

      /* Toast Notification Styling */
      #toastContainer { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; gap: 0.75rem; }
      .toast {
        padding: 0.875rem 1.25rem; border-radius: 0.5rem; color: white;
        font-size: 0.875rem; font-weight: 500; opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform: translateY(100%);
        min-width: 280px; max-width: 380px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex; align-items: center; gap: 0.75rem;
        cursor: pointer;
      }
      .toast.show { opacity: 1; transform: translateY(0); }
      .toast.success { background-color: var(--success-color); }
      .toast.error { background-color: var(--error-color); }
      .toast.info { background-color: var(--primary-color); }
      .toast.warning { background-color: var(--warning-color); }

      /* Analysis Tab Styling */
      .analysis-section { margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px dashed var(--border-color); }
      .analysis-section:first-child { margin-top: 0; padding-top: 0; border-top: none; }
      .analysis-section h4 { font-size: 0.9rem; font-weight: 600; color: var(--secondary-color); margin-bottom: 0.75rem; padding-bottom: 0.25rem; border-bottom: 1px solid #e5e7eb;}
      .analysis-item { display: flex; justify-content: space-between; padding: 0.375rem 0; font-size: 0.875rem; }
      .analysis-item-label { color: var(--text-secondary); font-weight: 500; }
      .analysis-item-value { color: var(--text-primary); text-align: right; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .paths-list {
          max-height: 180px; overflow-y: auto; background-color: #f9fafb; border: 1px solid var(--border-color);
          border-radius: 0.375rem; padding: 0.75rem 1rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          font-size: 0.8rem; color: #374151; /* gray-700 */ line-height: 1.5;
      }
      .paths-list::-webkit-scrollbar { width: 6px; }
      .paths-list::-webkit-scrollbar-thumb { background: #d1d5db; } /* gray-300 */

      /* Help Section Styling (Example - if using integrated section) */
      .help-section { background-color: #eef2ff; /* indigo-50 */ border: 1px solid #c7d2fe; /* indigo-200 */ border-radius: 0.5rem; padding: 1rem; }
      .help-section h3 { color: var(--secondary-color); font-weight: 600; margin-bottom: 0.5rem; }
      .help-section p { color: #4338ca; /* indigo-700 */ font-size: 0.875rem; line-height: 1.6; }
      .help-section code { background-color: rgba(255,255,255,0.5); padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-size: 0.8rem; }

      /* Utility Classes */
      .icon-sm { width: 1rem; height: 1rem; display: inline-block; vertical-align: middle; }
      .icon-md { width: 1.25rem; height: 1.25rem; display: inline-block; vertical-align: middle; }
      .icon-lg { width: 1.5rem; height: 1.5rem; display: inline-block; vertical-align: middle; }
      .icon-xl { width: 1.75rem; height: 1.75rem; display: inline-block; vertical-align: middle; }
      /* Icon colors using filter (keep if needed, or use inline SVG with currentColor) */
      .icon-primary { filter: invert(39%) sepia(98%) saturate(2372%) hue-rotate(218deg) brightness(95%) contrast(90%); } /* approx blue-600 */
      .icon-secondary { filter: invert(31%) sepia(80%) saturate(4000%) hue-rotate(240deg) brightness(90%) contrast(95%); } /* approx indigo-600 */
      .icon-success { filter: invert(58%) sepia(53%) saturate(1300%) hue-rotate(110deg) brightness(90%) contrast(90%); } /* approx emerald-500 */
      .icon-warning { filter: invert(75%) sepia(50%) saturate(1500%) hue-rotate(350deg) brightness(100%) contrast(90%); } /* approx amber-500 */
      .icon-error { filter: invert(45%) sepia(60%) saturate(2000%) hue-rotate(335deg) brightness(95%) contrast(90%); } /* approx red-500 */
      .icon-white { filter: brightness(0) invert(1); }

    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

    <div id="toastContainer"></div>

    <header class="bg-white shadow-md border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-screen-xl mx-auto px-4 py-3 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                 <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/binary.svg" alt="Tree Icon" class="icon-lg text-blue-600 icon-primary">
                 <h1 class="text-xl font-bold text-slate-900 tracking-tight">
                    Tree Visualizer <span class="text-blue-600">4.0</span>
                </h1>
            </div>
            <div class="flex items-center space-x-1">
                <button id="helpBtn" title="Help / Instructions" class="btn btn-ghost btn-icon">
                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/help-circle.svg" alt="Help" class="icon-md">
                </button>
                <button id="settingsBtn" title="Settings" class="btn btn-ghost btn-icon">
                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/settings-2.svg" alt="Settings" class="icon-md">
                 </button>
             </div>
        </div>
    </header>

    <main class="max-w-screen-xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">

            <div class="lg:col-span-4 space-y-6">
                <div class="card">
                    <div class="card-header">
                        <h2>
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/file-input.svg" alt="Input" class="icon-md icon-primary">
                            Tree Input
                        </h2>
                    </div>
                    <div class="tab-container">
                        <button id="textTabBtn" class="tab active">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/file-text.svg" alt="" class="icon-sm"> Text
                        </button>
                        <button id="jsonTabBtn" class="tab">
                             <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/braces.svg" alt="" class="icon-sm"> JSON
                        </button>
                    </div>
                    <div id="textInputTab" class="card-content tab-content active">
                        <label for="treeTextInput" class="block text-sm font-medium text-slate-700 mb-2">Enter node values (comma-separated)</label>
                        <input type="text" id="treeTextInput" class="form-input" placeholder="e.g., 50, 30, 70, 20, 40, 60, 80" value="1,2,3,4,5,6,7">
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed">Use 'null', 'None', or empty strings for empty nodes in level-order input.</p>
                    </div>
                    <div id="jsonInputTab" class="card-content tab-content">
                        <label for="treeJsonInput" class="block text-sm font-medium text-slate-700 mb-2">Enter tree structure in JSON format</label>
                        <textarea id="treeJsonInput" class="form-textarea font-mono text-xs" placeholder='{ "value": 50, "left": { ... }, "right": { ... } }'>{"value": 1, "left": {"value": 2, "left": {"value": 4}, "right": {"value": 5}}, "right": {"value": 3, "left": {"value": 6}, "right": {"value": 7}}}</textarea>
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed">Structure: `{"value": v, "left": node | null, "right": node | null}`</p>
                    </div>
                    <div class="card-footer flex gap-3">
                        <button id="generateTreeBtn" class="btn btn-primary flex-1">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/refresh-cw.svg" alt="" class="icon-sm icon-white"> Generate Tree
                        </button>
                        <button id="analyzeTreeBtn" class="btn btn-success flex-1">
                             <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/binary.svg" alt="" class="icon-sm icon-white"> Analyze Tree
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/wrench.svg" alt="Tools" class="icon-md icon-primary"> Tools
                        </h2>
                    </div>
                    <div class="card-content grid grid-cols-2 gap-3">
                        <button id="downloadPngBtn" title="Download Visualization as PNG" class="tool-button">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/image-down.svg" alt="" class="icon-md icon-secondary">
                            <span>PNG Export</span>
                        </button>
                        <button id="downloadSvgBtn" title="Download Visualization as SVG" class="tool-button">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/file-code-2.svg" alt="" class="icon-md icon-secondary">
                            <span>SVG Export</span>
                        </button>
                        <button id="saveTreeBtn" title="Save Tree Data as JSON" class="tool-button">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/save.svg" alt="" class="icon-md icon-primary">
                            <span>Save Tree</span>
                        </button>
                        <button id="loadTreeBtn" title="Load Tree Data from JSON" class="tool-button">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/folder-open.svg" alt="" class="icon-md icon-warning">
                            <span>Load Tree</span>
                        </button>
                         <input type="file" id="loadFileInput" accept=".json,application/json" class="hidden">
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>
                             <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/list-tree.svg" alt="Examples" class="icon-md icon-primary"> Load Examples
                        </h2>
                    </div>
                    <div class="card-content space-y-2">
                        <button class="example-tree-btn w-full text-left p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition duration-150" data-values="1,2,3,4,5,6,7">
                            <div class="font-medium text-sm text-slate-800">Perfect Binary Tree</div>
                            <div class="text-xs text-slate-500">Complete, all levels filled (1-7)</div>
                        </button>
                        <button class="example-tree-btn w-full text-left p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition duration-150" data-values="10,5,15,3,7,null,18">
                            <div class="font-medium text-sm text-slate-800">Binary Search Tree</div>
                            <div class="text-xs text-slate-500">BST property (left &lt; root &lt; right)</div>
                        </button>
                        <button class="example-tree-btn w-full text-left p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition duration-150" data-values="1,null,2,null,3,null,4,null,5">
                            <div class="font-medium text-sm text-slate-800">Right Skewed Tree</div>
                            <div class="text-xs text-slate-500">Nodes lean heavily to the right</div>
                        </button>
                         <button class="example-tree-btn w-full text-left p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 transition duration-150" data-values="50,30,70,20,40,60,80,10,null,35,45,null,null,75,null">
                            <div class="font-medium text-sm text-slate-800">Larger BST Example</div>
                            <div class="text-xs text-slate-500">More complex structure</div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="card">
                    <div id="treeInfoDisplay" class="px-4 py-2.5 bg-blue-50 text-blue-800 text-sm font-medium border-b border-blue-200 flex items-center gap-2 transition-colors duration-300 rounded-t-xl">
                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/info.svg" alt="Info" class="icon-md flex-shrink-0">
                        <span id="treeInfoText" class="flex-grow">Generate or load a tree to see details and visualization.</span>
                    </div>

                    <div class="tab-container">
                        <button id="visualizationTabBtn" class="tab active">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/network.svg" alt="" class="icon-sm"> Visualization
                        </button>
                        <button id="animationTabBtn" class="tab">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/play-circle.svg" alt="" class="icon-sm"> Traversal Animation
                        </button>
                         <button id="analysisTabBtn" class="tab">
                            <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/search-code.svg" alt="" class="icon-sm"> Analysis & Results
                        </button>
                    </div>

                    <div id="visualizationTab" class="tab-content active">
                        <div class="p-4">
                            <div class="mb-4 flex flex-wrap gap-x-4 gap-y-2 justify-between items-center border-b border-slate-100 pb-3">
                                <div class="flex items-center space-x-1">
                                    <button id="zoomInBtn" title="Zoom In" class="btn btn-ghost btn-icon">
                                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/zoom-in.svg" alt="Zoom In" class="icon-md">
                                    </button>
                                    <button id="zoomOutBtn" title="Zoom Out" class="btn btn-ghost btn-icon">
                                         <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/zoom-out.svg" alt="Zoom Out" class="icon-md">
                                     </button>
                                    <button id="resetZoomBtn" title="Fit to View" class="btn btn-ghost btn-icon">
                                         <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/maximize-2.svg" alt="Fit View" class="icon-md">
                                     </button>
                                    <button id="togglePhysicsBtn" title="Toggle Physics Simulation" class="btn btn-ghost btn-icon">
                                         <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/move.svg" alt="Toggle Physics" class="icon-md">
                                     </button>
                                </div>
                                 <div class="flex items-center space-x-3">
                                    <label for="nodeColorInput" class="text-sm font-medium text-slate-600 whitespace-nowrap">Node:</label>
                                    <input type="color" id="nodeColorInput" value="#2563EB" class="form-input w-8 h-8 p-0 border border-slate-300 rounded-md cursor-pointer appearance-none">
                                    <label for="edgeStyleSelect" class="text-sm font-medium text-slate-600 ml-2 whitespace-nowrap">Edge:</label>
                                    <select id="edgeStyleSelect" class="form-select py-1.5 text-sm">
                                        <option value="dynamic">Dynamic</option>
                                        <option value="continuous">Continuous</option>
                                        <option value="straightCross">Straight</option>
                                    </select>
                                </div>
                            </div>
                            <div id="network">
                                 <div class="network-placeholder">
                                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/loader-2.svg" alt="Loading" class="icon-md animate-spin">
                                    <span>Loading Visualization...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="animationTab" class="tab-content">
                         <div class="p-4 space-y-4">
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-3 border-b border-slate-100 pb-3">
                                 <div class="flex items-center gap-2">
                                    <label for="traversalTypeSelect" class="text-sm font-medium text-slate-700">Traversal:</label>
                                    <select id="traversalTypeSelect" class="form-select py-1.5 text-sm">
                                        <option value="preOrder">Pre-order</option>
                                        <option value="inOrder">In-order</option>
                                        <option value="postOrder">Post-order</option>
                                        <option value="levelOrder">Level-order (BFS)</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="startAnimationBtn" class="btn btn-success">
                                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/play.svg" alt="" class="icon-sm icon-white"> Play
                                    </button>
                                    <button id="pauseAnimationBtn" disabled class="btn btn-outline">
                                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/pause.svg" alt="" class="icon-sm"> Pause
                                    </button>
                                    <button id="stopAnimationBtn" disabled class="btn btn-outline">
                                        <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/stop-circle.svg" alt="" class="icon-sm"> Stop
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 ml-auto">
                                    <label for="animationSpeedRange" class="text-sm font-medium text-slate-700">Speed:</label>
                                    <input type="range" id="animationSpeedRange" min="100" max="2000" value="1000" step="50" class="form-range w-24 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer range-sm">
                                    <span id="speedValue" class="text-sm text-slate-600 w-12 text-right tabular-nums">1.0s</span>
                                </div>
                            </div>
                            <div id="animationNetwork">
                                 <div class="network-placeholder">
                                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/play.svg" alt="Play" class="icon-md">
                                    <span>Select traversal and press Play</span>
                                </div>
                            </div>
                             <div class="mt-4">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Traversal Sequence:</label>
                                <div id="traversalResult" class="p-3 bg-slate-100 rounded-md text-sm text-slate-700 font-mono min-h-[40px] flex items-center flex-wrap gap-1 border border-slate-200">
                                    <span class="text-slate-400 italic">Result will appear here...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="analysisTab" class="tab-content">
                         <div class="p-4 space-y-4">
                             <h3 class="text-lg font-semibold text-slate-800 mb-3 border-b pb-2">Analysis & Traversals</h3>
                             <div id="analysisResultsContainer" class="space-y-3 text-sm text-slate-700">
                                 <p class="italic text-slate-500">Run the 'Analyze Tree' function from the input section to see results here.</p>
                                 </div>
                         </div>
                    </div>

                </div> </div> </div> </main>

    <footer class="mt-12 py-6 border-t border-slate-200">
      <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-slate-500 flex items-center justify-center gap-2">
    <span>Developed by <a href="https://github.com/bilolkobilov" target="_blank" class="text-slate-500 hover:text-slate-700 font-medium">bilolkobilov</a></span>
    <a href="https://github.com/bilolkobilov" target="_blank" class="text-slate-500 hover:text-slate-700">
        <svg class="w-5 h-5 inline-block" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.167 6.839 9.49.5.092.682-.217.682-.483 0-.237-.008-.866-.012-1.7-2.782.604-3.369-1.34-3.369-1.34-.455-1.157-1.11-1.466-1.11-1.466-.906-.62.069-.608.069-.608 1.002.07 1.529 1.031 1.529 1.031.89 1.525 2.336 1.085 2.904.83.091-.645.349-1.085.635-1.335-2.22-.253-4.555-1.11-4.555-4.943 0-1.09.39-1.98 1.029-2.68-.103-.253-.446-1.272.097-2.65 0 0 .84-.27 2.75 1.027a9.563 9.563 0 0 1 2.5-.336c.847.004 1.698.114 2.5.336 1.91-1.297 2.75-1.027 2.75-1.027.543 1.378.2 2.397.097 2.65.64.7 1.029 1.59 1.029 2.68 0 3.842-2.337 4.687-4.564 4.936.36.31.678.923.678 1.86 0 1.343-.012 2.426-.012 2.756 0 .268.18.578.688.48C19.137 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"></path>
        </svg>
    </a>
</div>

    </footer>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title flex items-center gap-2">
                     <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/help-circle.svg" alt="Help" class="icon-md text-blue-600">
                     Help & Instructions
                </h2>
                <button id="closeHelpModal" class="btn btn-ghost btn-icon p-1 -mr-2">
                    <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x.svg" alt="Close" class="icon-md">
                </button>
            </div>
            <div class="modal-body text-sm text-slate-600 leading-relaxed space-y-4">
                <div>
                    <h4 class="font-semibold text-slate-700 mb-1">1. Inputting Your Tree:</h4>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><strong>Text Input:</strong> Enter comma-separated values. Use <code>null</code>, <code>None</code>, or leave empty for missing nodes (level-order). Example: <code>50,30,70,null,40</code></li>
                        <li><strong>JSON Input:</strong> Use a nested structure: <code>{"value": v, "left": {...}, "right": {...}}</code>. Set children to <code>null</code> if absent.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-slate-700 mb-1">2. Generating & Analyzing:</h4>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li>Click <strong>Generate Tree</strong> to parse input and show the visualization.</li>
                        <li>Click <strong>Analyze Tree</strong> to compute metrics (height, width, balance, etc.) and display them in the 'Analysis & Results' tab. Generation automatically triggers analysis.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-slate-700 mb-1">3. Interacting with Tabs:</h4>
                     <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><strong>Visualization:</strong> View the interactive graph. Drag nodes (visual only), zoom, pan. Use toolbar buttons (zoom, fit, physics toggle) and controls (node color, edge style).</li>
                        <li><strong>Traversal Animation:</strong> Select a traversal type, adjust speed, and click 'Play' to see the animation. Results appear below the graph.</li>
                        <li><strong>Analysis & Results:</strong> View detailed metrics, properties, traversal lists, and root-to-leaf paths for the current tree.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-slate-700 mb-1">4. Using Tools & Examples:</h4>
                     <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><strong>Tools:</strong> Export the visualization (PNG/SVG) or save/load the tree structure (JSON).</li>
                        <li><strong>Examples:</strong> Click buttons to quickly load pre-defined tree structures into the text input.</li>
                    </ul>
                </div>
            </div>
             <div class="modal-footer">
                 <button id="gotItHelpBtn" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h2 class="modal-title flex items-center gap-2">
                     <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/settings-2.svg" alt="Settings" class="icon-md text-blue-600">
                     Visualization Settings
                 </h2>
                <button id="closeSettingsModal" class="btn btn-ghost btn-icon p-1 -mr-2">
                     <img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x.svg" alt="Close" class="icon-md">
                </button>
            </div>
            <form id="settingsForm">
                <div class="modal-body space-y-5">
                    <div>
                        <label for="layoutDirection" class="block text-sm font-medium text-slate-700 mb-1">Layout Direction</label>
                        <select id="layoutDirection" name="layoutDirection" class="form-select">
                            <option value="UD">Up-Down (Default)</option>
                            <option value="DU">Down-Up</option>
                            <option value="LR">Left-Right</option>
                            <option value="RL">Right-Left</option>
                        </select>
                    </div>
                     <div>
                        <label for="nodeSpacing" class="block text-sm font-medium text-slate-700 mb-1">Node Spacing</label>
                        <input type="number" id="nodeSpacing" name="nodeSpacing" min="50" max="300" step="10" value="100" class="form-input">
                        <p class="text-xs text-slate-500 mt-1">Distance between nodes in the same level (default: 100).</p>
                    </div>
                     <div>
                        <label for="levelSeparation" class="block text-sm font-medium text-slate-700 mb-1">Level Separation</label>
                        <input type="number" id="levelSeparation" name="levelSeparation" min="50" max="400" step="10" value="150" class="form-input">
                        <p class="text-xs text-slate-500 mt-1">Distance between tree levels (default: 150).</p>
                    </div>
                     <div class="flex items-center">
                        <input type="checkbox" id="hierarchicalSort" name="hierarchicalSort" class="form-checkbox h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mr-2">
                        <label for="hierarchicalSort" class="block text-sm text-slate-700">Enable Hierarchical Sorting</label>
                    </div>
                </div>
                <div class="modal-footer">
                     <button type="button" id="cancelSettingsBtn" class="btn btn-outline">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Settings</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- DOM Element References ---
        const textInput = document.getElementById('treeTextInput');
        const jsonInput = document.getElementById('treeJsonInput');
        const generateBtn = document.getElementById('generateTreeBtn');
        const analyzeBtn = document.getElementById('analyzeTreeBtn');
        const textTabBtn = document.getElementById('textTabBtn');
        const jsonTabBtn = document.getElementById('jsonTabBtn');
        const textInputTab = document.getElementById('textInputTab');
        const jsonInputTab = document.getElementById('jsonInputTab');
        const networkContainer = document.getElementById('network');
        const animationNetworkContainer = document.getElementById('animationNetwork');
        const traversalResultDiv = document.getElementById('traversalResult');
        const treeInfoDisplay = document.getElementById('treeInfoDisplay');
        const treeInfoText = document.getElementById('treeInfoText');
        const downloadPngBtn = document.getElementById('downloadPngBtn');
        const downloadSvgBtn = document.getElementById('downloadSvgBtn');
        const saveTreeBtn = document.getElementById('saveTreeBtn');
        const loadTreeBtn = document.getElementById('loadTreeBtn');
        const loadFileInput = document.getElementById('loadFileInput');
        const exampleBtns = document.querySelectorAll('.example-tree-btn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetZoomBtn = document.getElementById('resetZoomBtn');
        const togglePhysicsBtn = document.getElementById('togglePhysicsBtn');
        const nodeColorInput = document.getElementById('nodeColorInput');
        const edgeStyleSelect = document.getElementById('edgeStyleSelect');
        const visualizationTabBtn = document.getElementById('visualizationTabBtn');
        const animationTabBtn = document.getElementById('animationTabBtn');
        const analysisTabBtn = document.getElementById('analysisTabBtn');
        const visualizationTab = document.getElementById('visualizationTab');
        const animationTab = document.getElementById('animationTab');
        const analysisTab = document.getElementById('analysisTab');
        const analysisResultsContainer = document.getElementById('analysisResultsContainer');
        const traversalTypeSelect = document.getElementById('traversalTypeSelect');
        const startAnimationBtn = document.getElementById('startAnimationBtn');
        const pauseAnimationBtn = document.getElementById('pauseAnimationBtn');
        const stopAnimationBtn = document.getElementById('stopAnimationBtn');
        const animationSpeedRange = document.getElementById('animationSpeedRange');
        const speedValueSpan = document.getElementById('speedValue');
        const helpBtn = document.getElementById('helpBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const helpModal = document.getElementById('helpModal');
        const settingsModal = document.getElementById('settingsModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        const gotItHelpBtn = document.getElementById('gotItHelpBtn'); // Added Got It button
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
        const settingsForm = document.getElementById('settingsForm');
        const layoutDirectionSelect = document.getElementById('layoutDirection');
        const nodeSpacingInput = document.getElementById('nodeSpacing');
        const levelSeparationInput = document.getElementById('levelSeparation');
        const hierarchicalSortCheckbox = document.getElementById('hierarchicalSort');
        const toastContainer = document.getElementById('toastContainer');

        // --- State Variables ---
        let network = null; // Vis.js network instance for main visualization
        let animationNetwork = null; // Vis.js network instance for animation
        let treeData = { nodes: new vis.DataSet([]), edges: new vis.DataSet([]) }; // Initialize with empty datasets
        let rootNode = null; // Root of the internal tree structure
        let nodeCounter = 1; // For generating unique node IDs
        let animationTimeout = null; // Timeout ID for animation steps
        let animationPaused = false;
        let animationRunning = false;
        let currentAnimationNodes = new vis.DataSet([]); // Initialize animation datasets
        let currentAnimationEdges = new vis.DataSet([]);
        let physicsEnabled = false; // Keep physics off by default for trees
        let currentInputType = 'text'; // 'text' or 'json'
        let currentAnalysis = null; // Store the latest analysis results

        // --- Vis.js Network Options ---
        function getNetworkOptions(enablePhysics = physicsEnabled, isAnimation = false) {
            const baseNodeColor = nodeColorInput.value || '#2563EB'; // Use current color picker value
            const layoutDirection = layoutDirectionSelect.value || 'UD';
            const nodeSpacing = parseInt(nodeSpacingInput.value, 10) || 100;
            const levelSeparation = parseInt(levelSeparationInput.value, 10) || 150;
            const sortMethod = hierarchicalSortCheckbox.checked ? 'directed' : 'hubsize';

            const layoutSettings = {
                hierarchical: {
                    enabled: true,
                    direction: layoutDirection,
                    sortMethod: sortMethod,
                    nodeSpacing: nodeSpacing,
                    levelSeparation: levelSeparation,
                    treeSpacing: 200, // Spacing between different trees (if ever applicable)
                    blockShifting: true,
                    edgeMinimization: true,
                    parentCentralization: true,
                },
            };

            return {
                autoResize: true,
                height: '100%',
                width: '100%',
                nodes: {
                    shape: 'circle',
                    size: 22, // Slightly larger nodes
                    font: {
                        size: 14,
                        color: '#ffffff',
                        face: 'Inter',
                        strokeWidth: 0, // No text stroke
                    },
                    borderWidth: 2,
                    color: {
                        border: '#1e4ed8', // Slightly darker blue border
                        background: baseNodeColor, // Use dynamic color
                        highlight: {
                            border: '#f59e0b', // amber-500
                            background: '#fbbf24' // amber-400
                        },
                        hover: {
                            border: '#60a5fa', // blue-400
                            background: '#93c5fd' // blue-300
                        }
                    },
                    shadow: { enabled: true, size: 6, x: 2, y: 2, color: 'rgba(0,0,0,0.15)' } // Slightly enhanced shadow
                },
                edges: {
                    width: 1.75, // Slightly thicker edges
                    color: {
                        color: '#94a3b8', // slate-400
                        highlight: '#f59e0b',
                        hover: '#60a5fa'
                    },
                    arrows: { to: { enabled: false } },
                    smooth: {
                        enabled: true,
                        type: edgeStyleSelect.value === 'straightCross' ? 'straightCross' : (edgeStyleSelect.value === 'continuous' ? 'continuous' : 'dynamic'),
                        roundness: 0.5
                    }
                },
                physics: {
                    enabled: enablePhysics,
                    solver: 'hierarchicalRepulsion',
                     hierarchicalRepulsion: {
                        centralGravity: 0.0,
                        springLength: levelSeparation * 0.8, // Relate to level separation
                        springConstant: 0.015,
                        nodeDistance: nodeSpacing * 1.2, // Relate to node spacing
                        damping: 0.1
                    },
                    minVelocity: 0.75,
                    stabilization: { iterations: enablePhysics ? 200 : 150 } // More iterations if physics on
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    navigationButtons: false, // Using custom buttons
                    selectConnectedEdges: false,
                    dragNodes: true,
                    dragView: true,
                    zoomView: true
                },
                layout: layoutSettings,
            };
        }

        // --- Tree Building Logic ---
        class TreeNode {
            constructor(value, id) {
                this.value = value;
                this.left = null;
                this.right = null;
                this.id = id;
            }
        }

        function buildTreeFromLevelOrder(values) {
             // Filter out potential empty strings at the end if input ends with commas
             while (values.length > 0 && values[values.length - 1] === null) {
                 values.pop();
             }
             if (values.length === 0 || values[0] === null) {
                return null; // Empty or starts with null
            }

            nodeCounter = 1;
            const nodes = [];
            const edges = [];
            const rootVal = values[0];
            const root = new TreeNode(rootVal, nodeCounter++);
            nodes.push({ id: root.id, label: String(rootVal), level: 0 });

            const queue = [root];
            let i = 1;
            let level = 0;

            while (queue.length > 0 && i < values.length) {
                const currentLevelSize = queue.length;
                 level++; // Increment level for children
                for (let k = 0; k < currentLevelSize; k++) {
                    const currentNode = queue.shift();
                    if (!currentNode) continue; // Skip null placeholders in the queue

                    // Process left child
                    if (i < values.length) {
                        const leftVal = values[i++];
                        if (leftVal !== null) {
                            const leftNode = new TreeNode(leftVal, nodeCounter++);
                            currentNode.left = leftNode;
                            nodes.push({ id: leftNode.id, label: String(leftVal), level: level });
                            edges.push({ from: currentNode.id, to: leftNode.id });
                            queue.push(leftNode);
                        } else {
                            queue.push(null); // Push null to maintain structure if value is null
                        }
                    }

                    // Process right child
                    if (i < values.length) {
                        const rightVal = values[i++];
                        if (rightVal !== null) {
                            const rightNode = new TreeNode(rightVal, nodeCounter++);
                            currentNode.right = rightNode;
                            nodes.push({ id: rightNode.id, label: String(rightVal), level: level });
                            edges.push({ from: currentNode.id, to: rightNode.id });
                            queue.push(rightNode);
                        } else {
                             queue.push(null); // Push null to maintain structure
                        }
                    }
                }
            }
            return { root, nodes, edges };
        }

        function buildTreeFromJson(jsonObj) {
            if (!jsonObj || typeof jsonObj.value === 'undefined') return null;
            nodeCounter = 1;
            const nodes = [];
            const edges = [];
            function traverse(jsonNode, level) {
                if (!jsonNode || typeof jsonNode.value === 'undefined') return null;
                const nodeId = nodeCounter++;
                const treeNode = new TreeNode(jsonNode.value, nodeId);
                nodes.push({ id: nodeId, label: String(jsonNode.value), level: level });
                if (jsonNode.left) {
                    const leftChild = traverse(jsonNode.left, level + 1);
                    if (leftChild) {
                        treeNode.left = leftChild;
                        edges.push({ from: nodeId, to: leftChild.id });
                    }
                }
                if (jsonNode.right) {
                    const rightChild = traverse(jsonNode.right, level + 1);
                    if (rightChild) {
                        treeNode.right = rightChild;
                        edges.push({ from: nodeId, to: rightChild.id });
                    }
                }
                return treeNode;
            }
            const root = traverse(jsonObj, 0);
            return { root, nodes, edges };
        }

        // --- Tree Traversal Algorithms ---
        function getTraversalSequence(node, type) {
            const result = []; const nodeIds = [];
            function preOrder(n) { if (!n) return; result.push(n.value); nodeIds.push(n.id); preOrder(n.left); preOrder(n.right); }
            function inOrder(n) { if (!n) return; inOrder(n.left); result.push(n.value); nodeIds.push(n.id); inOrder(n.right); }
            function postOrder(n) { if (!n) return; postOrder(n.left); postOrder(n.right); result.push(n.value); nodeIds.push(n.id); }
            function levelOrder(n) { if (!n) return; const q = [n]; while (q.length > 0) { const c = q.shift(); result.push(c.value); nodeIds.push(c.id); if (c.left) q.push(c.left); if (c.right) q.push(c.right); } }
            switch (type) {
                case 'preOrder': preOrder(node); break;
                case 'inOrder': inOrder(node); break;
                case 'postOrder': postOrder(node); break;
                case 'levelOrder': levelOrder(node); break;
                default: console.error("Invalid traversal type:", type); return { values: [], nodeIds: [] };
            }
            return { values: result, nodeIds: nodeIds };
        }

        // --- Tree Analysis Functions ---
        function calculateHeight(node) { if (!node) return -1; return 1 + Math.max(calculateHeight(node.left), calculateHeight(node.right)); }
        function calculateMaxWidth(node) { if (!node) return 0; let maxW = 0; const q = [node]; while (q.length > 0) { const lvlSize = q.length; maxW = Math.max(maxW, lvlSize); for (let i = 0; i < lvlSize; i++) { const c = q.shift(); if (c.left) q.push(c.left); if (c.right) q.push(c.right); } } return maxW; }
        let treeDiameter = 0; function calculateDiameterRecursive(node) { if (!node) return -1; const lH = calculateDiameterRecursive(node.left); const rH = calculateDiameterRecursive(node.right); treeDiameter = Math.max(treeDiameter, lH + rH + 2); return 1 + Math.max(lH, rH); } function calculateDiameter(node) { treeDiameter = 0; calculateDiameterRecursive(node); return treeDiameter; }
        function findAllPathsToLeaf(node) { const paths = []; function findPathsRec(n, currentPath) { if (!n) return; currentPath.push(n.value); if (!n.left && !n.right) { paths.push(currentPath.join(' → ')); } else { findPathsRec(n.left, [...currentPath]); findPathsRec(n.right, [...currentPath]); } } findPathsRec(node, []); return paths; }

        function analyzeTreeStructure(node) {
            if (!node) return { nodeCount: 0, leafCount: 0, height: -1, maxWidth: 0, diameter: 0, isBST: true, isComplete: true, isFull: true, isPerfect: true, minDepth: 0, maxDepth: -1, balanceFactor: 0, isBalanced: true, minValue: null, maxValue: null, pathsToLeaf: [], traversals: { preOrder: [], inOrder: [], postOrder: [], levelOrder: [] } };
            let nodeCount = 0, leafCount = 0, isBST = true, minValue = node.value, maxValue = node.value, isBalanced = true;
            function checkBST(n, min, max) { if (!n) return true; if ((min !== null && n.value <= min) || (max !== null && n.value >= max)) { isBST = false; return false; } minValue = Math.min(minValue, n.value); maxValue = Math.max(maxValue, n.value); return checkBST(n.left, min, n.value) && checkBST(n.right, n.value, max); }
            function getHeightAndCounts(n) { if (!n) return -1; nodeCount++; const lH = getHeightAndCounts(n.left); const rH = getHeightAndCounts(n.right); if (!n.left && !n.right) leafCount++; return 1 + Math.max(lH, rH); }
            function getNodeBalanceFactor(n) { if (!n) return 0; return calculateHeight(n.left) - calculateHeight(n.right); }
            function checkBalanceRecursive(n) { if (!n) return true; if (Math.abs(getNodeBalanceFactor(n)) > 1) isBalanced = false; checkBalanceRecursive(n.left); checkBalanceRecursive(n.right); return isBalanced; }
            checkBST(node, null, null); const height = getHeightAndCounts(node); checkBalanceRecursive(node); const rootBalanceFactor = getNodeBalanceFactor(node);
            let isComplete = true, isFull = true, nonFullFound = false, q = [node], idx = 0;
            if (nodeCount > 0) { while (idx < nodeCount) { if (q.length === 0) { isComplete = false; isFull = false; break; } const curr = q.shift(); if (!curr) { nonFullFound = true; continue; } idx++; if (nonFullFound) isComplete = false; const hasL = !!curr.left, hasR = !!curr.right; if ((hasL && !hasR) || (!hasL && hasR)) isFull = false; if ((!hasL || !hasR) && (hasL || hasR)) nonFullFound = true; if (curr.left) q.push(curr.left); else q.push(null); if (curr.right) q.push(curr.right); else q.push(null); } }
            const isPerfect = isFull && (nodeCount === Math.pow(2, height + 1) - 1); if (isPerfect) isComplete = true;
            let minD = Infinity, maxD = -Infinity; function findMinMaxDepth(n, d) { if (!n) return; if (!n.left && !n.right) { minD = Math.min(minD, d); maxD = Math.max(maxD, d); return; } findMinMaxDepth(n.left, d + 1); findMinMaxDepth(n.right, d + 1); } if (node) findMinMaxDepth(node, 0); else { minD = 0; maxD = -1; }
            const analysisResults = { nodeCount, leafCount, height, maxWidth: calculateMaxWidth(node), diameter: calculateDiameter(node), isBST, isComplete, isFull, isPerfect, minDepth: nodeCount > 0 ? minD : 0, maxDepth: nodeCount > 0 ? maxD : -1, balanceFactor: rootBalanceFactor, isBalanced, minValue: nodeCount > 0 ? minValue : null, maxValue: nodeCount > 0 ? maxValue : null, pathsToLeaf: findAllPathsToLeaf(node), traversals: { preOrder: getTraversalSequence(node, 'preOrder').values, inOrder: getTraversalSequence(node, 'inOrder').values, postOrder: getTraversalSequence(node, 'postOrder').values, levelOrder: getTraversalSequence(node, 'levelOrder').values } };
            currentAnalysis = analysisResults; return analysisResults;
        }

        // --- UI Update Functions ---
        function updateNetwork(nodes, edges, fitView = true) {
            // Ensure datasets are Vis DataSet objects
            if (!(treeData.nodes instanceof vis.DataSet)) {
                treeData.nodes = new vis.DataSet(nodes);
            } else {
                treeData.nodes.clear();
                treeData.nodes.add(nodes);
            }
             if (!(treeData.edges instanceof vis.DataSet)) {
                treeData.edges = new vis.DataSet(edges);
            } else {
                 treeData.edges.clear();
                 treeData.edges.add(edges);
            }

            const options = getNetworkOptions();
            const placeholder = networkContainer.querySelector('.network-placeholder');

            if (!network) { // Initialize network if it doesn't exist
                network = new vis.Network(networkContainer, treeData, options);
                network.on("stabilizationIterationsDone", () => {
                    if (fitView && network && treeData.nodes.length > 0) {
                        network.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
                    }
                     if (physicsEnabled && network) network.setOptions({ physics: { enabled: true } }); // Re-enable physics after stabilization if needed
                });
                 network.on("selectNode", params => console.log("Selected node ID:", params.nodes[0]));
                 network.on("dragEnd", params => { if (params.nodes.length > 0) console.log(`Node ${params.nodes[0]} dragged visually.`); });
            } else { // Update existing network
                // Important: Use setData to ensure layout recalculation if needed
                network.setData(treeData);
                // Re-apply options in case settings changed (like color)
                network.setOptions(options);
                 // Explicitly fit view after data update if requested
                 if (fitView && treeData.nodes.length > 0) {
                     // Use timeout to ensure rendering cycle completes
                     setTimeout(() => network?.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' } }), 50);
                 }
            }

            // Manage placeholder visibility
             if (placeholder) placeholder.style.display = (treeData.nodes.length === 0) ? 'flex' : 'none';
        }

        function updateAnimationNetwork(nodes, edges) {
            // Ensure datasets are Vis DataSet objects for animation network
            if (!(currentAnimationNodes instanceof vis.DataSet)) {
                currentAnimationNodes = new vis.DataSet(nodes.map(n => ({...n, color: undefined, shadow: undefined })));
            } else {
                 currentAnimationNodes.clear();
                 currentAnimationNodes.add(nodes.map(n => ({...n, color: undefined, shadow: undefined })));
            }
             if (!(currentAnimationEdges instanceof vis.DataSet)) {
                currentAnimationEdges = new vis.DataSet(edges.map(e => ({...e, color: undefined, width: undefined })));
            } else {
                 currentAnimationEdges.clear();
                 currentAnimationEdges.add(edges.map(e => ({...e, color: undefined, width: undefined })));
            }

            const animationData = { nodes: currentAnimationNodes, edges: currentAnimationEdges };
            const options = getNetworkOptions(false, true); // Physics off for animation
            const placeholder = animationNetworkContainer.querySelector('.network-placeholder');

            if (!animationNetwork) {
                animationNetwork = new vis.Network(animationNetworkContainer, animationData, options);
                animationNetwork.on("stabilizationIterationsDone", () => {
                    if (animationNetwork && currentAnimationNodes.length > 0) {
                        animationNetwork.fit({ animation: { duration: 300, easingFunction: 'easeInOutQuad' } });
                    }
                });
            } else {
                animationNetwork.setData(animationData);
                animationNetwork.setOptions(options);
                 if (currentAnimationNodes.length > 0) {
                     setTimeout(() => animationNetwork?.fit({ animation: { duration: 300, easingFunction: 'easeInOutQuad' } }), 50);
                 }
            }

            if (placeholder) {
                 placeholder.style.display = (currentAnimationNodes.length === 0) ? 'flex' : 'none';
                 placeholder.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/play.svg" alt="Play" class="icon-md"><span>Select traversal and press Play</span>';
            }
        }

        function updateTreeInfo(analysis) {
            if (!analysis || analysis.nodeCount === 0) {
                treeInfoText.textContent = "Generate or load a tree to see details.";
                treeInfoDisplay.className = 'px-4 py-2.5 bg-blue-50 text-blue-800 text-sm font-medium border-b border-blue-200 flex items-center gap-2 transition-colors duration-300 rounded-t-xl';
                return;
            }
            const infoParts = [ `Nodes: ${analysis.nodeCount}`, `Height: ${analysis.height}`, `Leaves: ${analysis.leafCount}`, `Width: ${analysis.maxWidth}`, `Diameter: ${analysis.diameter}`, `BST: ${analysis.isBST ? 'Yes' : 'No'}`, `Balanced: ${analysis.isBalanced ? 'Yes' : 'No'}`, `Perfect: ${analysis.isPerfect ? 'Yes' : 'No'}`, ];
            treeInfoText.textContent = infoParts.join('  |  '); // More spacing
            treeInfoDisplay.className = 'px-4 py-2.5 bg-emerald-50 text-emerald-800 text-sm font-medium border-b border-emerald-200 flex items-center gap-2 transition-colors duration-300 rounded-t-xl';
        }

        function displayAnalysisResults(analysis) {
            analysisResultsContainer.innerHTML = ''; // Clear previous
            if (!analysis || analysis.nodeCount === 0) {
                analysisResultsContainer.innerHTML = '<p class="italic text-slate-500">Run the \'Analyze Tree\' function first.</p>';
                return;
            }
             function createItem(label, value) { const item = document.createElement('div'); item.className = 'analysis-item'; item.innerHTML = `<span class="analysis-item-label">${label}:</span><span class="analysis-item-value">${value}</span>`; return item; }
             const metrics = document.createElement('div'); metrics.className = 'analysis-section'; metrics.innerHTML = '<h4>Core Metrics</h4>';
             const props = document.createElement('div'); props.className = 'analysis-section'; props.innerHTML = '<h4>Tree Properties</h4>';
             const traversals = document.createElement('div'); traversals.className = 'analysis-section'; traversals.innerHTML = '<h4>Traversals</h4>';
             const paths = document.createElement('div'); paths.className = 'analysis-section'; paths.innerHTML = '<h4>Root-to-Leaf Paths</h4>';
             // Metrics
             Object.entries({ "Total Node Count": analysis.nodeCount, "Leaf Node Count": analysis.leafCount, "Height (Max Depth)": analysis.height, "Width (Max Nodes/Level)": analysis.maxWidth, "Diameter (Longest Path)": analysis.diameter, "Minimum Depth (Root=0)": analysis.minDepth, "Maximum Depth (Root=0)": analysis.maxDepth, "Minimum Value": analysis.minValue ?? 'N/A', "Maximum Value": analysis.maxValue ?? 'N/A', }).forEach(([k, v]) => metrics.appendChild(createItem(k, v)));
             // Properties
             Object.entries({ "Is Balanced (All Nodes)": analysis.isBalanced ? 'Yes <span class="text-emerald-500 ml-1">(≤1)</span>' : 'No <span class="text-red-500 ml-1">(>1)</span>', "Root Balance Factor": analysis.balanceFactor, "Is Binary Search Tree (BST)": analysis.isBST ? 'Yes <span class="text-emerald-500 ml-1">✓</span>' : 'No <span class="text-red-500 ml-1">✗</span>', "Is Complete Tree": analysis.isComplete ? 'Yes' : 'No', "Is Full Tree": analysis.isFull ? 'Yes <span class="text-slate-500 ml-1">(0/2)</span>' : 'No', "Is Perfect Tree": analysis.isPerfect ? 'Yes <span class="text-emerald-500 ml-1">✓</span>' : 'No', }).forEach(([k, v]) => props.appendChild(createItem(k, v)));
             // Traversals
             Object.entries({ "Pre-order": analysis.traversals.preOrder.join(', ') || 'N/A', "In-order": analysis.traversals.inOrder.join(', ') || 'N/A', "Post-order": analysis.traversals.postOrder.join(', ') || 'N/A', "Level-order": analysis.traversals.levelOrder.join(', ') || 'N/A', }).forEach(([k, v]) => traversals.appendChild(createItem(k, v)));
             // Paths
             if (analysis.pathsToLeaf.length > 0) { const list = document.createElement('div'); list.className = 'paths-list'; list.innerHTML = analysis.pathsToLeaf.join('<br>'); paths.appendChild(list); } else { paths.innerHTML += `<p class="text-slate-500 italic text-sm">${analysis.nodeCount > 0 ? 'No leaf nodes found.' : 'Tree is empty.'}</p>`; }
             // Append all
             analysisResultsContainer.append(metrics, props, traversals, paths);
        }

        // --- Animation Logic ---
        function stopAnimation() { clearTimeout(animationTimeout); animationRunning = false; animationPaused = false; startAnimationBtn.disabled = (rootNode === null); pauseAnimationBtn.disabled = true; pauseAnimationBtn.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/pause.svg" alt="" class="icon-sm"> Pause'; pauseAnimationBtn.classList.remove('btn-success'); pauseAnimationBtn.classList.add('btn-outline'); stopAnimationBtn.disabled = true; traversalTypeSelect.disabled = false; if (animationNetwork && currentAnimationNodes) { const nodeIds = currentAnimationNodes.getIds(); if (nodeIds.length > 0) currentAnimationNodes.update(nodeIds.map(id => ({ id: id, color: undefined, shadow: undefined }))); } traversalResultDiv.innerHTML = '<span class="text-slate-400 italic">Result will appear here...</span>'; }
        function pauseResumeAnimation() { if (!animationRunning) return; animationPaused = !animationPaused; if (animationPaused) { clearTimeout(animationTimeout); pauseAnimationBtn.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/play.svg" alt="" class="icon-sm icon-white"> Resume'; pauseAnimationBtn.classList.remove('btn-outline'); pauseAnimationBtn.classList.add('btn-success'); } else { pauseAnimationBtn.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/pause.svg" alt="" class="icon-sm"> Pause'; pauseAnimationBtn.classList.remove('btn-success'); pauseAnimationBtn.classList.add('btn-outline'); animateStep(); } }
        let currentStep = 0; let traversalNodeIds = []; let traversalValues = [];
        function startAnimation() { if (!rootNode) { showToast("Please generate a tree first.", "warning"); return; } if (animationRunning) stopAnimation(); const type = traversalTypeSelect.value; const { values, nodeIds } = getTraversalSequence(rootNode, type); if (!nodeIds || nodeIds.length === 0) { showToast("Cannot perform traversal.", "error"); return; } traversalNodeIds = nodeIds; traversalValues = values; currentStep = 0; animationRunning = true; animationPaused = false; startAnimationBtn.disabled = true; pauseAnimationBtn.disabled = false; stopAnimationBtn.disabled = false; traversalTypeSelect.disabled = true; pauseAnimationBtn.innerHTML = '<img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/pause.svg" alt="" class="icon-sm"> Pause'; pauseAnimationBtn.classList.remove('btn-success'); pauseAnimationBtn.classList.add('btn-outline'); updateAnimationNetwork(treeData.nodes.get(), treeData.edges.get()); traversalResultDiv.innerHTML = ''; animateStep(); }
        function animateStep() { if (!animationRunning || animationPaused) return; if (currentStep >= traversalNodeIds.length) { showToast("Traversal animation complete!", "success", 2000); stopAnimation(); return; } const nodeId = traversalNodeIds[currentStep]; const nodeValue = traversalValues[currentStep]; if (animationNetwork && currentAnimationNodes) { if (currentStep > 0) { const prevNodeId = traversalNodeIds[currentStep - 1]; if (currentAnimationNodes.get(prevNodeId)) currentAnimationNodes.update({ id: prevNodeId, color: { background: '#a5f3fc', border: '#22d3ee' }, shadow: false }); } if (currentAnimationNodes.get(nodeId)) { currentAnimationNodes.update({ id: nodeId, color: { background: '#fcd34d', border: '#f59e0b' }, shadow: { enabled: true, size: 10, x: 3, y: 3, color: 'rgba(245,158,11,0.3)' } }); animationNetwork.focus(nodeId, { scale: Math.max(1.0, animationNetwork.getScale() * 1.05), animation: { duration: 300, easingFunction: 'easeOutQuad' } }); } } const valueSpan = document.createElement('span'); valueSpan.className = 'inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-medium mr-1 mb-1 animate-pulse'; valueSpan.textContent = nodeValue; traversalResultDiv.appendChild(valueSpan); setTimeout(() => valueSpan.classList.remove('animate-pulse'), 500); currentStep++; const speed = 2100 - parseInt(animationSpeedRange.value, 10); animationTimeout = setTimeout(animateStep, speed); }

        // --- Event Handlers ---
        textTabBtn.addEventListener('click', () => { textTabBtn.classList.add('active'); jsonTabBtn.classList.remove('active'); textInputTab.classList.add('active'); jsonInputTab.classList.remove('active'); currentInputType = 'text'; });
        jsonTabBtn.addEventListener('click', () => { jsonTabBtn.classList.add('active'); textTabBtn.classList.remove('active'); jsonInputTab.classList.add('active'); textInputTab.classList.remove('active'); currentInputType = 'json'; });
        visualizationTabBtn.addEventListener('click', () => switchDisplayTab('visualization'));
        animationTabBtn.addEventListener('click', () => switchDisplayTab('animation'));
        analysisTabBtn.addEventListener('click', () => switchDisplayTab('analysis'));

        function switchDisplayTab(tabId) {
             // Hide all content panels first
             document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
             // Deactivate all tab buttons
             document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
             // Activate the selected tab button and content panel
             document.getElementById(tabId + 'TabBtn').classList.add('active');
             document.getElementById(tabId + 'Tab').classList.add('active');

             // Special actions on tab switch
             if (tabId === 'visualization' && network) network.fit({ animation: true });
             else if (tabId === 'animation' && animationNetwork) animationNetwork.fit({ animation: true });
             else if (tabId === 'analysis') displayAnalysisResults(currentAnalysis); // Refresh analysis view
        }

        generateBtn.addEventListener('click', () => {
            let buildResult = null;
            try {
                stopAnimation(); rootNode = null; currentAnalysis = null; // Reset state
                let inputValues = [];
                if (currentInputType === 'text') {
                    inputValues = textInput.value.split(',')
                        .map(v => v.trim())
                        .map(v => (v.toLowerCase() === 'null' || v.toLowerCase() === 'none' || v === '') ? null : (isNaN(parseFloat(v)) ? v : parseFloat(v)));
                     // Handle empty or all-null input
                     if (inputValues.filter(v => v !== null).length === 0) {
                         showToast("Input is empty or contains only null values.", "error");
                         updateNetwork([], []); updateAnimationNetwork([], []); updateTreeInfo(null); displayAnalysisResults(null); startAnimationBtn.disabled = true;
                         return;
                     }
                    buildResult = buildTreeFromLevelOrder(inputValues);
                } else {
                    const jsonString = jsonInput.value.trim();
                     if (!jsonString) { showToast("JSON input is empty.", "error"); updateNetwork([], []); updateAnimationNetwork([], []); updateTreeInfo(null); displayAnalysisResults(null); startAnimationBtn.disabled = true; return; }
                    const jsonObj = JSON.parse(jsonString);
                    buildResult = buildTreeFromJson(jsonObj);
                }

                if (buildResult && buildResult.nodes.length > 0) {
                    rootNode = buildResult.root;
                    updateNetwork(buildResult.nodes, buildResult.edges);
                    updateAnimationNetwork(buildResult.nodes, buildResult.edges);
                    const analysis = analyzeTreeStructure(rootNode); // Analyze immediately
                    updateTreeInfo(analysis);
                    displayAnalysisResults(analysis); // Display analysis
                    showToast("Tree generated and analyzed!", "success", 2000);
                    startAnimationBtn.disabled = false;
                } else {
                    showToast("Could not build tree. Check input format.", "error");
                    rootNode = null; currentAnalysis = null; updateNetwork([], []); updateAnimationNetwork([], []); updateTreeInfo(null); displayAnalysisResults(null); startAnimationBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error generating tree:", error);
                showToast(`Error: ${error.message}. Check input.`, "error", 5000);
                rootNode = null; currentAnalysis = null; updateNetwork([], []); updateAnimationNetwork([], []); updateTreeInfo(null); displayAnalysisResults(null); startAnimationBtn.disabled = true;
            }
        });

        analyzeBtn.addEventListener('click', () => {
            if (!rootNode) { showToast("Generate or load a tree first.", "warning"); return; }
            try {
                const analysis = analyzeTreeStructure(rootNode); // Re-analyze
                updateTreeInfo(analysis); displayAnalysisResults(analysis);
                switchDisplayTab('analysis'); // Switch to analysis tab
                showToast("Tree analysis complete.", "success", 2000);
            } catch (error) { console.error("Error analyzing tree:", error); showToast(`Analysis Error: ${error.message}`, "error", 4000); }
        });

        exampleBtns.forEach(btn => { btn.addEventListener('click', () => { textInput.value = btn.getAttribute('data-values'); switchDisplayTab('visualization'); textTabBtn.click(); generateBtn.click(); showToast(`Loaded example: ${btn.querySelector('.font-medium').textContent}`, "info", 2500); }); });

        // Visualization Controls - Added checks for network existence
        zoomInBtn.addEventListener('click', () => network ? network.zoomIn() : showToast("No network to zoom.", "warning"));
        zoomOutBtn.addEventListener('click', () => network ? network.zoomOut() : showToast("No network to zoom.", "warning"));
        resetZoomBtn.addEventListener('click', () => network ? network.fit({ animation: true }) : showToast("No network to fit.", "warning"));
        togglePhysicsBtn.addEventListener('click', () => { if (!network) { showToast("No network to toggle physics.", "warning"); return; } physicsEnabled = !physicsEnabled; network.setOptions({ physics: { enabled: physicsEnabled } }); togglePhysicsBtn.classList.toggle('bg-blue-100', physicsEnabled); togglePhysicsBtn.classList.toggle('text-blue-700', physicsEnabled); showToast(`Physics ${physicsEnabled ? 'enabled' : 'disabled'}.`, "info", 1500); if (physicsEnabled) network.stabilize(); });
        nodeColorInput.addEventListener('input', (e) => { if (!network) return; const newColor = e.target.value; const nodeUpdates = treeData.nodes.getIds().map(id => ({ id: id, color: { background: newColor } })); treeData.nodes.update(nodeUpdates); if (currentAnimationNodes) { const animNodeUpdates = currentAnimationNodes.getIds().map(id => ({ id: id, color: { background: newColor } })); currentAnimationNodes.update(animNodeUpdates); } network.setOptions({ nodes: { color: { background: newColor } } }); if(animationNetwork) animationNetwork.setOptions({ nodes: { color: { background: newColor } } }); });
        edgeStyleSelect.addEventListener('change', (e) => { if (!network) return; const type = e.target.value; const smooth = { enabled: true, type: type, roundness: 0.5 }; network.setOptions({ edges: { smooth: smooth } }); if(animationNetwork) animationNetwork.setOptions({ edges: { smooth: smooth } }); });

        // Animation Controls
        startAnimationBtn.addEventListener('click', startAnimation);
        pauseAnimationBtn.addEventListener('click', pauseResumeAnimation);
        stopAnimationBtn.addEventListener('click', stopAnimation);
        animationSpeedRange.addEventListener('input', (e) => { speedValueSpan.textContent = `${((2100 - parseInt(e.target.value, 10)) / 1000).toFixed(1)}s`; });

        // File Handling
        function downloadFile(filename, content, mimeType) { const blob = new Blob([content], { type: mimeType }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        downloadPngBtn.addEventListener('click', () => { if (!network || !rootNode) { showToast("No tree to export.", "warning"); return; } const originalBg = networkContainer.style.backgroundColor; networkContainer.style.backgroundColor = '#ffffff'; html2canvas(networkContainer, { useCORS: true, logging: false, scale: 2 }).then(canvas => { const link = document.createElement('a'); link.download = 'tree-visualization.png'; link.href = canvas.toDataURL(); link.click(); showToast("PNG export started.", "success"); }).catch(err => { console.error("PNG Export Error:", err); showToast("Error exporting PNG.", "error"); }).finally(() => { networkContainer.style.backgroundColor = originalBg; }); });
        downloadSvgBtn.addEventListener('click', () => { if (!network || !rootNode) { showToast("No tree to export.", "warning"); return; } try { const { nodes: currentNodes, edges: currentEdges } = treeData; if (!currentNodes || !currentEdges || currentNodes.length === 0) { showToast("Cannot export empty tree.", "warning"); return; } const positions = network.getPositions(); const bb = network.getPositions(currentNodes.getIds()); let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity; Object.values(bb).forEach(pos => { minX = Math.min(minX, pos.x); maxX = Math.max(maxX, pos.x); minY = Math.min(minY, pos.y); maxY = Math.max(maxY, pos.y); }); if (!isFinite(minX)) { minX = -100; maxX = 100; minY = -100; maxY = 100; } const padding = 50; const width = (maxX - minX) + 2 * padding; const height = (maxY - minY) + 2 * padding; const offsetX = -minX + padding; const offsetY = -minY + padding; let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg" style="background-color: #ffffff; font-family: Inter, sans-serif;">`; svg += `<style>.node-label{font-size:13px;fill:white;font-weight:500;text-anchor:middle;dominant-baseline:central;}.edge{stroke:#94a3b8;stroke-width:1.75;}</style>`; currentEdges.forEach(edge => { const from = positions[edge.from], to = positions[edge.to]; if (from && to) svg += `<line class="edge" x1="${from.x+offsetX}" y1="${from.y+offsetY}" x2="${to.x+offsetX}" y2="${to.y+offsetY}"/>`; }); currentNodes.forEach(node => { const pos = positions[node.id]; if (pos) { const nodeColor = node.color?.background || nodeColorInput.value || '#2563EB'; const borderColor = node.color?.border || '#1e4ed8'; const r = network.options.nodes.size || 22; svg += `<circle cx="${pos.x+offsetX}" cy="${pos.y+offsetY}" r="${r}" fill="${nodeColor}" stroke="${borderColor}" stroke-width="2"/><text class="node-label" x="${pos.x+offsetX}" y="${pos.y+offsetY}">${node.label}</text>`; } }); svg += `</svg>`; downloadFile('tree-visualization.svg', svg, 'image/svg+xml'); showToast("SVG export started.", "success"); } catch (e) { console.error("SVG Export Error:", e); showToast("Error exporting SVG.", "error"); } });
        saveTreeBtn.addEventListener('click', () => { if (!rootNode) { showToast("No tree data to save.", "warning"); return; } try { function toJson(n){ if(!n) return null; return { value: n.value, left: toJson(n.left), right: toJson(n.right) }; } const jsonString = JSON.stringify(toJson(rootNode), null, 2); downloadFile('tree-data.json', jsonString, 'application/json'); showToast("Tree data saved as JSON.", "success"); } catch (e) { console.error("Save Error:", e); showToast("Error saving tree data.", "error"); } });
        loadTreeBtn.addEventListener('click', () => loadFileInput.click());
        loadFileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; if (file.type !== 'application/json') { showToast("Invalid file type. JSON only.", "error"); loadFileInput.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { jsonInput.value = e.target.result; switchDisplayTab('visualization'); jsonTabBtn.click(); generateBtn.click(); showToast(`Loaded tree from ${file.name}`, "success"); } catch (err) { console.error("Load Error:", err); showToast(`Error reading file: ${err.message}`, "error"); } finally { loadFileInput.value = ''; } }; reader.onerror = () => { showToast("Error reading file.", "error"); loadFileInput.value = ''; }; reader.readAsText(file); });

        // --- Modals ---
        helpBtn.addEventListener('click', () => helpModal.style.display = 'block');
        settingsBtn.addEventListener('click', () => {
            try { // Populate settings modal safely
                layoutDirectionSelect.value = network?.options.layout.hierarchical.direction || 'UD';
                nodeSpacingInput.value = network?.options.layout.hierarchical.nodeSpacing || 100;
                levelSeparationInput.value = network?.options.layout.hierarchical.levelSeparation || 150;
                hierarchicalSortCheckbox.checked = !!(network && network.options.layout.hierarchical.sortMethod === 'directed');
            } catch (e) { console.error("Error populating settings:", e); /* Use defaults */ }
            settingsModal.style.display = 'block';
        });
        closeHelpModal.addEventListener('click', () => helpModal.style.display = 'none');
        gotItHelpBtn.addEventListener('click', () => helpModal.style.display = 'none'); // Added
        closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
        cancelSettingsBtn.addEventListener('click', () => settingsModal.style.display = 'none');
        window.addEventListener('click', (event) => { if (event.target === helpModal) helpModal.style.display = 'none'; if (event.target === settingsModal) settingsModal.style.display = 'none'; });

        // Handle Settings Form Submission
        settingsForm.addEventListener('submit', (e) => { e.preventDefault(); applySettings(); });

        function applySettings() {
             try {
                // Get new options based on form values
                const newOptions = getNetworkOptions(physicsEnabled); // Pass current physics state

                // Apply options to the main network if it exists
                if (network) {
                    network.setOptions(newOptions);
                    // Important: To apply layout changes, often need to redraw or reset data
                    // Let's try setting data again to force layout recalculation
                    network.setData(treeData); // This might trigger stabilization
                    // Fit after potential stabilization
                    setTimeout(() => network?.fit({ animation: true }), 300);
                }

                // Apply layout options (without physics) to animation network if it exists
                if (animationNetwork) {
                    const animOptions = getNetworkOptions(false, true); // Get options for animation (no physics)
                    animationNetwork.setOptions(animOptions);
                    animationNetwork.setData({ nodes: currentAnimationNodes, edges: currentAnimationEdges }); // Force redraw
                    setTimeout(() => animationNetwork?.fit({ animation: true }), 300);
                }

                settingsModal.style.display = 'none'; // Close modal
                showToast("Settings applied successfully.", "success", 2000);
             } catch (error) {
                 console.error("Error applying settings:", error);
                 showToast("Failed to apply settings. Check console.", "error");
             }
        }

        // --- Toast Notifications ---
        function showToast(message, type = 'info', duration = 3500) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let iconSrc = '';
            switch(type) { case 'success': iconSrc = 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/check-circle.svg'; break; case 'error': iconSrc = 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x-circle.svg'; break; case 'warning': iconSrc = 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/alert-triangle.svg'; break; default: iconSrc = 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/info.svg'; break; }
            toast.innerHTML = `<img src="${iconSrc}" alt="${type}" class="icon-md flex-shrink-0 icon-white"><span>${message}</span>`;
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show')); // Animate in
            const timeoutId = setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); }, duration);
            toast.addEventListener('click', () => { clearTimeout(timeoutId); toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, { once: true });
        }

         // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial speed display
            speedValueSpan.textContent = `${((2100 - parseInt(animationSpeedRange.value, 10)) / 1000).toFixed(1)}s`;
            // Disable animation buttons initially
            startAnimationBtn.disabled = true; pauseAnimationBtn.disabled = true; stopAnimationBtn.disabled = true;
            // Initial display updates
            updateTreeInfo(null); displayAnalysisResults(null);
            // Generate default tree on load
            generateBtn.click();
             // Show welcome toast
             showToast("Welcome to Tree Visualizer 4.0!", "info", 4000);
        });

    </script>
</body>
</html>
